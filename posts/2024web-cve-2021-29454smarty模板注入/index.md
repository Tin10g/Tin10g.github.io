# Smarty模板注入


&gt; [参考文章]: https://xz.aliyun.com/t/11085?time__1311=Cq0x2Qi%3DomqYqGNDQie7KEq7qv7Oq8a

# Smarty模板注入

&gt; CVE-2021-29454

## 漏洞报告

Smarty 是 PHP 的模板引擎，有助于将表示 (HTML/CSS) 与应用程序逻辑分离。在 3.1.42 和 4.0.2 版本之前，模板作者可以通过制作恶意数学字符串来运行任意 PHP 代码。如果数学字符串作为用户提供的数据传递给数学函数，则**外部用户可以通过制作恶意数学字符串来运行任意 PHP 代码**。用户应升级到版本 3.1.42 或 4.0.2 以接收补丁。

## 源码修复

在`/plugins/function.math.php`中添加下面代码

```
// Remove whitespaces
    $equation = preg_replace(&#39;/\s&#43;/&#39;, &#39;&#39;, $equation);

    // Adapted from https://www.php.net/manual/en/function.eval.php#107377
    $number = &#39;(?:\d&#43;(?:[,.]\d&#43;)?|pi|π)&#39;; // What is a number
    $functionsOrVars = &#39;((?:0x[a-fA-F0-9]&#43;)|([a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*))&#39;;
    $operators = &#39;[&#43;\/*\^%-]&#39;; // Allowed math operators
    $regexp = &#39;/^((&#39;.$number.&#39;|&#39;.$functionsOrVars.&#39;|(&#39;.$functionsOrVars.&#39;\s*\((?1)&#43;\)|\((?1)&#43;\)))(?:&#39;.$operators.&#39;(?2))?)&#43;$/&#39;;

    if (!preg_match($regexp, $equation)) {
        trigger_error(&#34;math: illegal characters&#34;, E_USER_WARNING);
        return;
    }
```

对恶意拼接的数学字符串进行过滤（漏洞利用POC格式其实也在这里写出来了，参考`$regexp`）

```
$regexp = &#39;/^((&#39;.$number.&#39;|&#39;.$functionsOrVars.&#39;|(&#39;.$functionsOrVars.&#39;\s*\((?1)&#43;\)|\((?1)&#43;\)))(?:&#39;.$operators.&#39;(?2))?)&#43;$/&#39;;
```

而在较低版本下，缺少过滤部分，进而导致RCE

并且，在`tests/UnitTests/TemplateSource/ValueTests/Math/MathTest.php`中，也有添加

```
/**
     * @expectedException PHPUnit_Framework_Error_Warning
     */
    public function testBackticksIllegal()
    {
        $expected = &#34;22.00&#34;;
        $tpl = $this-&gt;smarty-&gt;createTemplate(&#39;eval:{$x = &#34;4&#34;}{$y = &#34;5.5&#34;}{math equation=&#34;`ls` x * y&#34; x=$x y=$y}&#39;);
        $this-&gt;assertEquals($expected, $this-&gt;smarty-&gt;fetch($tpl));
    }

    /**
     * @expectedException PHPUnit_Framework_Error_Warning
     */
    public function testDollarSignsIllegal()
    {
        $expected = &#34;22.00&#34;;
        $tpl = $this-&gt;smarty-&gt;createTemplate(&#39;eval:{$x = &#34;4&#34;}{$y = &#34;5.5&#34;}{math equation=&#34;$&#34; x=$x y=$y}&#39;);
        $this-&gt;assertEquals($expected, $this-&gt;smarty-&gt;fetch($tpl));
    }

    /**
     * @expectedException PHPUnit_Framework_Error_Warning
     */
    public function testBracketsIllegal()
    {
        $expected = &#34;I&#34;;
        $tpl = $this-&gt;smarty-&gt;createTemplate(&#39;eval:{$x = &#34;0&#34;}{$y = &#34;1&#34;}{math equation=&#34;((y/x).(x))[x]&#34; x=$x y=$y}&#39;);
        $this-&gt;assertEquals($expected, $this-&gt;smarty-&gt;fetch($tpl));
    }
```


---

> Author: [Ting](Tin10g.github.io)  
> URL: http://localhost:1313/posts/2024web-cve-2021-29454smarty%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/  

